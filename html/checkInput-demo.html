<div class="insertSection">
    <div id="insertSection">
        <!-- crumbs -->
        <div class="c-crumbs">
            <p class="c-crumbs-text c-clear">
                <span class="c-crumbs-link c-fl">版本管理 ></span>
                <span class="c-crumbs-sub c-fl">SDK版本信息管理</span>
            </p>
        </div>
        <!-- crumbs -->
        <!-- c-page-wrap -->
        <div class="c-page-wrap">
            <!-- c-page-panel -->
            <div class="c-page-panel" style="overflow: visible;">
                <ul class="c-edit-items">
                    <li class="c-edit-li c-clear">
                        <p class="c-edit-desc c-fl">版本编号：</p>
                        <input id="versionNo" class="c-fl c-input-w466" type="text" data-type="版本编号" placeholder="请输入版本编号，格式示例2.0.0.1" autocomplete="off">
                        <div class="c-error"></div>
                    </li>
                    <li class="c-edit-li c-clear">
                        <p class="c-edit-desc c-fl">操作系统：</p>
                        <input id="operateSys" class="c-fl c-input-w466" type="text" data-type="操作系统" placeholder="请输入版本，格式示例Android 6.0~Android 8.0" autocomplete="off">
                        <div class="c-error"></div>
                    </li>
                    <li class="c-edit-li c-clear" style="position: relative">
                        <p class="c-edit-desc c-fl" style="margin-top: 26px;"><span id="service-help" class="service-help"></span>启用服务：</p>
                        <div class="c-fl c-input-w466 ">
                            <ul id="service-box" class="service-select">
                                <li><input type="checkbox" name="fun_0">RT-SMS</li>
                                <li><input type="checkbox" name="fun_1">RX-SMS</li>
                                <li><input type="checkbox" name="fun_2">RT-TXT</li>
                                <li><input type="checkbox" name="fun_3">RX-TXT</li>
                                <li><input type="checkbox" name="fun_4">RT-RCS</li>
                                <li><input type="checkbox" name="fun_5">RX-RCS</li>
                            </ul>
                        </div>
                        <div id="service-tip" class="service-tip">
                            <p style="margin-bottom: 15px">产品能力说明</p>
                            <p>产品名称<span style="margin-left: 100px">释义</span></p>
                            <ul class="tip-left">
                                <li>RT-SMS</li>
                                <li>RT-TXT</li>
                                <li>RT-RCS</li>
                                <li style="padding-top: 20px;">RX-SMS</li>
                                <li style="padding-top: 40px;">RX-RMS</li>
                                <li style="padding-top: 20px;">RX-RCS</li>
                            </ul>
                            <ul class="tip-right">
                                <li>运营商短信转IM消息</li>
                                <li>纯IM文本消息</li>
                                <li>通过IM通知的方式发梦网富信，具有展示图文和交互能力</li>
                                <li>通过普通短信通知的方式，将短信转成运营商富信或梦网富信（限长文本信息）</li>
                                <li>通过普通短信通知的方式打开运营商富信，具有展示图文能力</li>
                                <li>通过普通短信通知的方式打开梦网富信，具有展示图文和交互能力</li>
                            </ul>
                            <span class="tip-triangle"></span>
                        </div>
                    </li>
                    <li class="c-edit-li c-clear">
                        <p class="c-edit-desc c-fl">版本描述：</p>
                        <textarea id="versionDes" class="c-fl c-input-w466" data-type="版本描述" placeholder="请输入版本描述，建议不要超过500个字符。" autocomplete="off" maxlength="500" style="padding: 4px 6px;"></textarea>
                        <div class="c-error"></div>
                    </li>
                    <li class="c-edit-li c-text-ct">
                        <button id="submit" class="btn btn-primary" type="button">保存</button>
                        <button id="turnBack" class="btn c-btn-default-border c-marl10" type="button">退出</button>
                    </li>
                </ul>
            </div>
            <!-- /c-page-panel -->
        </div>
        <!-- /c-page-wrap -->
        <script>
		(function($, win){
				var PageObj = {
					addVerInfoUrl: "/v1/imSdkVer/addSdk",  // 添加SDK版本信息接口
					IOLock: false,		// 数据请求锁，防止同时多次同样访问
					funs:'',

					// 初始化
					init: function(){
						// 停止其他模块中未结束AJAX请求
						if(CommonMethods.CurrentAjax) {
							CommonMethods.CurrentAjax.abort();
						}

						// 判断是否登录
						var customerId = sessionStorage.customerId;
						if (customerId == undefined || customerId == '') {
							window.location.href = CommonMethods.loginPageUrl;
						}

						// 执行UI事件绑定
						this.bindUI();
					},

					// 操作DOM绑定事件
					bindUI: function(){
						var _self = this;

						// 保存
						$("#submit").on("click", function(){
							// 获取能力整数值
							_self.getFuns();
							if(_self.checkSubmitData()){
								_self.submitData();
							}
						});

						$("input[type='text']").on("focus", function(){
							$(this).removeClass("c-input-error");
						}).on("blur", function(){
							_self.checkInputEmpty($(this), $(this).attr("data-type"));
							_self.checkInputFormat($(this), $(this).attr("data-type"));
						}).on("input propertychange", function(){
							$(this).removeClass("c-input-error");
						});

						// 提示
						$("#service-help").hover(function () {
							$("#service-tip").show();
						},function() {
							$("#service-tip").hide();
						});

						// 版本描述输入框置空
						$("#versionDes").focus(function () {
							$(this).val('');
						});

						// 退出
						$("#turnBack").on('click',function(){
							window.history.go(-1);
						});
					},


					/*
					** @fn getPostDataParams获取提交数据参数
					** @return {JSON} options请求参数
					*/
					getPostDataParams: function(){
						var _verNo = $("#versionNo").val(),		        			// 版本编号
							_opeSys = $("#operateSys").val(),		                // 操作系统
							_funs = this.funs,                                      // 能力整数值
							_versionDes = $("#versionDes").val();                   // 版本描述

						var obj = {
							"sdkVer": _verNo,
							"osVer": _opeSys,
							"funs": _funs,
							"fileDesc": _versionDes,
						}
						return JSON.stringify(obj);
					},

					// 提交数据
					submitData: function(){
						var _self = this,
							_url = CommonMethods.AJAXURL + this.addVerInfoUrl,
							_IOParams = {
								"url": _url,
								"contentType": "application/json;charset=utf-8",
								"data": _self.getPostDataParams(),
								"successCB": _self.submitDataSuccessCB,
								"errorCB": _self.IOErrorCB,
								"completeCB": _self.IOcompleteCB
							};

						// 显示加载界面
						CommonMethods.toggleLoad(true);

						// 判断是否有数据请求锁
						if(!this.IOLock){
							// 页面数据请求上锁
							this.IOLock = true;
							// 执行数据请求
							CommonMethods.IO(_IOParams);
						}
					},

					// 获取列表数据成功后回调
					submitDataSuccessCB: function(rst){
						var _code = rst.code,			// 服务端返回状态码
							_errInfo = rst.errorInfo;  // 服务端返回错误信息

						if(_code === 0){
							window.location.replace("#/versionManage/versionSDK.html");
						}else if(_code === 2){
							alert(rst.errorInfo.errorMsg);
							window.location.href = CommonMethods.loginPageUrl;
						}else{
							alert(_errInfo.errorMsg);
						}
					},

					// 校验所有输入
					checkSubmitData: function(){
						if(this.checkInputEmpty($("#versionNo"), "版本标号")&&this.checkInputEmpty($("#operateSys"), "操作系统")&&this.checkInputFormat($("#versionNo"), "版本标号")&&this.checkInputFormat($("#operateSys"), "操作系统")){
							return true;
						}else{
							return false;
						}
					},

					/*
					** @fn checkInputEmpty校验输入框是否为空
					** @params {element} checkEl校验的元素
					** @params {string} desc校验的描述
					*/
					checkInputEmpty: function(checkEl, desc){
						var _checkVal = $.trim(checkEl.val());

						if(_checkVal === ""){
							checkEl.addClass("c-input-error");
							checkEl.siblings(".c-error").text(desc+"不能为空");
							return false;
						}else{
							checkEl.removeClass("c-input-error");
							checkEl.siblings(".c-error").text("");
							return true;
						}
					},

					/*
					** @fn checkInputFormat校验输入框格式是否正确
					** @params {element} checkEl校验的元素
					** @params {string} desc校验的描述
					*/
					checkInputFormat: function(checkEl, desc){
						var _checkVal = $.trim(checkEl.val());
						var _id = $(checkEl).attr('id');

						var flag = false;
						if(_id == "versionNo"){
							var reg =/^(\d{1,4}\.)(\d{1,4}\.)(\d{1,4}\.)(\d{1,4})$/;
							if(!reg.test(_checkVal)){
								checkEl.addClass("c-input-error");
								checkEl.siblings(".c-error").text(desc+"格式不正确，格式示例 2.0.0.1");
							}else{
								checkEl.removeClass("c-input-error");
								checkEl.siblings(".c-error").text("");
								return true;
							}
						}

						if(_id == "operateSys"){
							var reg= new RegExp(/^Android(\s){0,2}(\d{1,4}\.\d{1,4})~Android(\s){0,2}(\d{1,4}\.\d{1,4})$/i);
							var result = _checkVal.match(reg);
							var flag = false;
							if(result!=null&&result.length>1){
								var  _ver1 = result[2];
								var _ver2 = result[4];
								if(_ver2>=_ver1){
									flag = true;
								}
							}
							if(!flag){
								checkEl.addClass("c-input-error");
								checkEl.siblings(".c-error").text(desc+"格式不正确，格式示例 Android 6.0~Android 8.0");
							}else{
								checkEl.removeClass("c-input-error");
								checkEl.siblings(".c-error").text("");
								return true;
							}
						}
					},


					getFuns: function (){
						var length = $("#service-box input[type='checkbox']").size();
						if (length < 0) {
							return 0;
						}
						var funs = new Array(length);
						$("#service-box input[type='checkbox']").each(function(){
							var name = this.name;
							var id = name.split("_")[1];
							if(this.checked){
								funs[length-id] = 1;
							}else{
								funs[length-id] = 0;
							}
						});

						this.funs =  parseInt(funs.join(""),2);

					},


				// 数据请求失败回调
					IOErrorCB: function(e){
						alert("系统错误！");
					},

					// 数据请求完成回调
					IOcompleteCB: function(){
						// 解锁数据请求锁
						PageObj.IOLock = false;
						// 隐藏加载界面
						CommonMethods.toggleLoad(false);
					}
				};
				PageObj.init();
			}(window.jQuery, window));
		</script>
    </div>
</div>
